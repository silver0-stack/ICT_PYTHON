<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ì¸ ë§ë™ë¬´ AI</title>
</head>
<body>
    <h1>ë…¸ì¸ ë§ë™ë¬´ AI</h1>
    <div>
        <label for="userMessage"></label>
        <input type="text" id="userMessage" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeydown="checkEnterKey(event)">
        <button onclick="sendTextMessage()">ì „ì†¡</button>
        <button onclick="speakMessage()">ìŒì„± ë“£ê¸°</button>
        <button onclick="startRealTimeConversation()">ğŸ¤ ì‹¤ì‹œê°„ ìŒì„± ëŒ€í™” ì‹œì‘</button>
        <button onclick="stopRealTimeConversation()">ğŸ›‘ ìŒì„± ëŒ€í™” ì¢…ë£Œ</button>
    </div>
    <div id="chatOutput"></div>

    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
        }

        const recognition = new SpeechRecognition();
        recognition.lang = "ko-KR";
        recognition.continuous = true;

        let isConversationActive = false;
        let silenceTimer;

        // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
        async function sendTextMessage() {
            const userMessage = document.getElementById("userMessage").value;

            if (!userMessage.trim()) {
                addMessageToChat("ì‹œìŠ¤í…œ: ì…ë ¥ëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            addMessageToChat(`ì‚¬ìš©ì: ${userMessage}`);
            const response = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: userMessage })
            });
            const data = await response.json();

            addMessageToChat(`AI: ${data.reply}`);
            await playTTS(data.reply);

            document.getElementById("userMessage").value = "";
        }

        // ëŒ€í™” ì‹œì‘
        function startRealTimeConversation() {
            if (isConversationActive) {
                addMessageToChat("ì‹œìŠ¤í…œ: ì´ë¯¸ ëŒ€í™”ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.");
                return;
            }
            isConversationActive = true;

            recognition.start();
            addMessageToChat("ì‹œìŠ¤í…œ: ì‹¤ì‹œê°„ ëŒ€í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");

            recognition.onresult = async function(event) {
                clearTimeout(silenceTimer);
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                addMessageToChat(`ì‚¬ìš©ì: ${transcript}`);

                const response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: transcript })
                });
                const data = await response.json();

                addMessageToChat(`AI: ${data.reply}`);
                await playTTS(data.reply);

                // startSilenceTimer();
            };

            recognition.onerror = function(event) {
                console.error("ìŒì„± ì¸ì‹ ì˜¤ë¥˜:", event.error);
                addMessageToChat(`ì‹œìŠ¤í…œ: ìŒì„± ì¸ì‹ ì˜¤ë¥˜ - ${event.error}`);
            };
        }

        // ëŒ€í™” ì¢…ë£Œ
        function stopRealTimeConversation() {
            if (!isConversationActive) {
                addMessageToChat("ì‹œìŠ¤í…œ: ëŒ€í™”ê°€ ì§„í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            isConversationActive = false;

            recognition.stop();
            clearTimeout(silenceTimer);
            addMessageToChat("ì‹œìŠ¤í…œ: ì‹¤ì‹œê°„ ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // ì¼ì • ì‹œê°„ ë™ì•ˆ ì¹¨ë¬µ ì‹œ ëŒ€í™” ì¢…ë£Œ
        function startSilenceTimer() {
            silenceTimer = setTimeout(() => {
                addMessageToChat("ì‹œìŠ¤í…œ: ì¼ì • ì‹œê°„ ë™ì•ˆ ë§ì”€ì´ ì—†ì–´ ëŒ€í™”ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.");
                stopRealTimeConversation();
            }, 10000); // 10ì´ˆ ë™ì•ˆ ì¹¨ë¬µ ì‹œ ì¢…ë£Œ
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addMessageToChat(message) {
            const chatOutput = document.getElementById("chatOutput");
            chatOutput.insertAdjacentHTML("afterbegin", `<p>${message}</p>`);
        }

        // AI ì‘ë‹µ ìŒì„± ì¬ìƒ
        async function playTTS(text) {
            const response = await fetch("/speak", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: text })
            });
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            await audio.play();
        }

        // Enter í‚¤ë¡œ í…ìŠ¤íŠ¸ ì „ì†¡
        function checkEnterKey(event) {
            if (event.key === "Enter") {
                sendTextMessage();
            }
        }

        async function speakMessage() {
            const userMessage = document.getElementById("userMessage").value;
            const response = await fetch("/speak", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: userMessage })
            });
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            await audio.play();
        }
    </script>
</body>
</html>
